// Main window for AuroraHeart IDE
import { VerticalBox, HorizontalBox, Button, TextEdit, ScrollView, ListView } from "std-widgets.slint";
import { Theme } from "theme.slint";

// File tree item model
export struct FileTreeItem {
    name: string,
    path: string,
    is-directory: bool,
}

export component MainWindow inherits Window {
    title: "AuroraHeart IDE";
    preferred-width: 1400px;
    preferred-height: 900px;
    background: Theme.background-dark;

    // Callbacks
    callback open-file();
    callback save-file();
    callback send-message(string);
    callback file-selected(string);
    callback text-edited();
    callback open-settings();
    callback save-api-key(string);
    callback load-api-key() -> string;
    callback clear-chat();

    // Properties
    in-out property <string> editor-text: "";
    in-out property <string> chat-input: "";
    in-out property <string> chat-output: "";
    in-out property <string> current-file: "";
    in-out property <string> project-name: "AuroraHeart";
    in-out property <string> status-message: "Ready";
    in-out property <[FileTreeItem]> file-tree-items: [];
    in-out property <bool> is-modified: false;
    in-out property <string> original-content: "";
    in-out property <bool> show-settings-dialog: false;
    in-out property <string> api-key-input: "";
    in-out property <string> api-key-masked: "";

    VerticalBox {
        padding: 0px;
        spacing: 0px;

        // Menu bar / Toolbar
        Rectangle {
            height: Theme.toolbar-height;
            background: Theme.toolbar-background;

            HorizontalBox {
                padding: Theme.padding-small;
                spacing: Theme.spacing-medium;
                alignment: start;

                Text {
                    text: "AuroraHeart";
                    color: Theme.text-accent;
                    font-size: Theme.font-size-large;
                    font-weight: 700;
                    vertical-alignment: center;
                }

                Rectangle {
                    width: 20px;
                }

                Button {
                    text: "Open File";
                    clicked => { root.open-file(); }
                }

                Button {
                    text: "Save";
                    enabled: root.current-file != "" && root.is-modified;
                    clicked => { root.save-file(); }
                }

                Rectangle {
                    width: 20px;
                }

                Button {
                    text: "Settings";
                    clicked => {
                        root.api-key-input = root.load-api-key();
                        root.show-settings-dialog = true;
                    }
                }

                Rectangle {
                    width: 20px;
                }

                Button {
                    text: "Clear Chat";
                    clicked => { root.clear-chat(); }
                }
            }
        }

        // Main content area
        HorizontalBox {
            padding: 0px;
            spacing: 0px;

            // File tree sidebar
            Rectangle {
                width: Theme.sidebar-width;
                background: Theme.background-light;

                VerticalBox {
                    padding: 0px;
                    spacing: 0px;

                    // Sidebar header
                    Rectangle {
                        height: 32px;
                        background: Theme.background-light;

                        HorizontalBox {
                            padding-left: Theme.padding-medium;
                            padding-right: Theme.padding-medium;

                            Text {
                                text: "FILES";
                                color: Theme.text-secondary;
                                font-size: Theme.font-size-small;
                                font-weight: 600;
                                vertical-alignment: center;
                            }
                        }
                    }

                    // File tree
                    Rectangle {
                        background: Theme.background-light;

                        if file-tree-items.length > 0: ListView {
                            for item in file-tree-items: Rectangle {
                                height: 24px;
                                background: touch-area.has-hover ? Theme.selection-background : transparent;

                                touch-area := TouchArea {
                                    clicked => {
                                        if !item.is-directory {
                                            root.file-selected(item.path);
                                        }
                                    }
                                }

                                HorizontalBox {
                                    padding-left: Theme.padding-medium;
                                    padding-right: Theme.padding-medium;
                                    spacing: Theme.spacing-small;

                                    Text {
                                        text: item.is-directory ? "üìÅ" : "üìÑ";
                                        font-size: Theme.font-size-small;
                                        vertical-alignment: center;
                                    }

                                    Text {
                                        text: item.name;
                                        color: Theme.text-primary;
                                        font-size: Theme.font-size-small;
                                        vertical-alignment: center;
                                    }
                                }
                            }
                        }

                        if file-tree-items.length == 0: VerticalBox {
                            padding: Theme.padding-medium;
                            alignment: start;

                            Text {
                                text: "No files loaded";
                                color: Theme.text-secondary;
                                font-size: Theme.font-size-small;
                            }

                            Text {
                                text: "Open a file to get started";
                                color: Theme.text-secondary;
                                font-size: Theme.font-size-small;
                            }
                        }
                    }
                }
            }

            // Editor and chat area
            VerticalBox {
                padding: 0px;
                spacing: 0px;

                // Editor and chat split
                HorizontalBox {
                    padding: 0px;
                    spacing: 0px;

                    // Editor pane
                    Rectangle {
                        background: Theme.background-dark;

                        VerticalBox {
                            padding: 0px;
                            spacing: 0px;

                            // Editor header
                            if root.current-file != "": Rectangle {
                                height: 32px;
                                background: Theme.background-medium;

                                HorizontalBox {
                                    padding-left: Theme.padding-medium;
                                    padding-right: Theme.padding-medium;
                                    spacing: Theme.spacing-small;

                                    if root.is-modified: Text {
                                        text: "‚óè";
                                        color: Theme.text-accent;
                                        font-size: Theme.font-size-normal;
                                        vertical-alignment: center;
                                    }

                                    Text {
                                        text: root.current-file;
                                        color: Theme.text-primary;
                                        font-size: Theme.font-size-small;
                                        vertical-alignment: center;
                                    }
                                }
                            }

                            // Editor content
                            Rectangle {
                                background: Theme.background-dark;

                                if root.current-file != "" || root.editor-text != "": VerticalBox {
                                    padding: Theme.padding-medium;

                                    TextEdit {
                                        text <=> root.editor-text;
                                        font-size: Theme.font-size-normal;
                                        edited => {
                                            root.text-edited();
                                        }
                                    }
                                }

                                if root.current-file == "" && root.editor-text == "": VerticalBox {
                                    alignment: center;

                                    Text {
                                        text: "Welcome to AuroraHeart IDE";
                                        color: Theme.text-accent;
                                        font-size: 20px;
                                        font-weight: 600;
                                    }

                                    Text {
                                        text: "Your AI-powered development environment";
                                        color: Theme.text-secondary;
                                        font-size: Theme.font-size-normal;
                                    }

                                    Rectangle { height: 20px; }

                                    Text {
                                        text: "Open a file or start coding to begin";
                                        color: Theme.text-secondary;
                                        font-size: Theme.font-size-small;
                                    }
                                }
                            }
                        }
                    }

                    // Chat panel
                    Rectangle {
                        width: Theme.chat-panel-width;
                        background: Theme.background-medium;

                        VerticalBox {
                            padding: 0px;
                            spacing: 0px;

                            // Chat header
                            Rectangle {
                                height: 32px;
                                background: Theme.background-medium;

                                HorizontalBox {
                                    padding-left: Theme.padding-medium;
                                    padding-right: Theme.padding-medium;

                                    Text {
                                        text: "AI ASSISTANT";
                                        color: Theme.text-secondary;
                                        font-size: Theme.font-size-small;
                                        font-weight: 600;
                                        vertical-alignment: center;
                                    }
                                }
                            }

                            // Chat output
                            Rectangle {
                                background: Theme.background-dark;

                                ScrollView {
                                    VerticalBox {
                                        padding: Theme.padding-medium;

                                        Text {
                                            text: root.chat-output;
                                            color: Theme.text-primary;
                                            font-size: Theme.font-size-normal;
                                            wrap: word-wrap;
                                        }
                                    }
                                }
                            }

                            // Chat input
                            Rectangle {
                                height: 80px;
                                background: Theme.background-medium;

                                VerticalBox {
                                    padding: Theme.padding-medium;
                                    spacing: Theme.spacing-small;

                                    TextEdit {
                                        text <=> root.chat-input;
                                        font-size: Theme.font-size-normal;
                                        placeholder-text: "Ask Claude for help...";
                                        height: 40px;
                                    }

                                    HorizontalBox {
                                        alignment: end;

                                        Button {
                                            text: "Send";
                                            enabled: root.chat-input != "";
                                            clicked => {
                                                root.send-message(root.chat-input);
                                                root.chat-input = "";
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        // Status bar
        Rectangle {
            height: Theme.statusbar-height;
            background: Theme.toolbar-background;

            HorizontalBox {
                padding-left: Theme.padding-medium;
                padding-right: Theme.padding-medium;
                spacing: Theme.spacing-medium;

                Text {
                    text: root.project-name;
                    color: Theme.text-accent;
                    font-size: Theme.font-size-small;
                    vertical-alignment: center;
                }

                Rectangle {
                    width: 20px;
                }

                Text {
                    text: root.status-message;
                    color: Theme.text-secondary;
                    font-size: Theme.font-size-small;
                    vertical-alignment: center;
                }
            }
        }
    }

    // Settings Dialog
    if root.show-settings-dialog: Rectangle {
        width: root.width;
        height: root.height;
        background: #00000088;

        Rectangle {
            width: 500px;
            height: 300px;
            background: Theme.background-medium;
            border-width: Theme.border-width;
            border-color: Theme.border-color;

            VerticalBox {
                padding: Theme.padding-medium;
                spacing: Theme.spacing-medium;

                // Dialog header
                HorizontalBox {
                    Text {
                        text: "Settings";
                        color: Theme.text-primary;
                        font-size: Theme.font-size-large;
                        font-weight: 700;
                        horizontal-alignment: left;
                    }

                    Rectangle {
                        // Spacer
                    }

                    Button {
                        text: "‚úï";
                        width: 30px;
                        clicked => {
                            root.show-settings-dialog = false;
                            root.api-key-input = "";
                        }
                    }
                }

                Rectangle {
                    height: 1px;
                    background: Theme.border-color;
                }

                // API Key section
                VerticalBox {
                    spacing: Theme.spacing-small;
                    alignment: start;

                    Text {
                        text: "Anthropic API Key";
                        color: Theme.text-primary;
                        font-size: Theme.font-size-normal;
                        font-weight: 600;
                    }

                    Text {
                        text: "Your API key is stored securely and encrypted locally.";
                        color: Theme.text-secondary;
                        font-size: Theme.font-size-small;
                        wrap: word-wrap;
                    }

                    Rectangle {
                        height: 10px;
                    }

                    TextEdit {
                        text <=> root.api-key-input;
                        placeholder-text: "Enter your Anthropic API key (sk-ant-...)";
                        font-size: Theme.font-size-normal;
                        height: 40px;
                    }

                    if root.api-key-masked != "": Text {
                        text: "Current key: " + root.api-key-masked;
                        color: Theme.text-secondary;
                        font-size: Theme.font-size-small;
                    }
                }

                Rectangle {
                    // Spacer to push buttons to bottom
                }

                // Dialog buttons
                HorizontalBox {
                    alignment: end;
                    spacing: Theme.spacing-small;

                    Button {
                        text: "Cancel";
                        clicked => {
                            root.show-settings-dialog = false;
                            root.api-key-input = "";
                        }
                    }

                    Button {
                        text: "Save";
                        enabled: root.api-key-input != "";
                        clicked => {
                            root.save-api-key(root.api-key-input);
                            root.show-settings-dialog = false;
                            root.api-key-input = "";
                        }
                    }
                }
            }
        }
    }
}
